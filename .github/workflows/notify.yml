name: Notify Guilded on Push or PR Merge

on:
  push:
    branches:
      - main
      - development
  pull_request:
    types: [closed]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true || github.event_name == 'push'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get latest commit info
        id: commit
        run: |
          echo "msg=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Send notification to Guilded
        run: |
          cat <<EOF > payload.json
          {
            "content": "üõ†Ô∏è GitHub Repo Event\n* Repo: ${{ github.repository }}\n* Event: ${{ github.event_name }}\n* Actor: ${{ github.actor }}\n* Branch: ${{ github.ref }}\n* Commit: ${{ steps.commit.outputs.sha }}\n* Commit Message: ${{ steps.commit.outputs.msg }}\n* Commit Author: ${{ steps.commit.outputs.author }}\n* EOM"
          }
          EOF

          curl -X POST -H "Content-Type: application/json" \
            -d @payload.json \
            https://discordapp.com/api/webhooks/1391497633545195722/Rg3a7em1DRtwPSXWDsGNcSqxsuYQQ2PjGYQuOiIaLfC4igxxG8_iQqryJc7du6sLU9cB
